{
   "AWSTemplateFormatVersion" : "2010-09-09",
   "Description" : "Conjur Instance",
   "Resources" : {
      "ConjurInstance" : {
         "Type" : "AWS::EC2::Instance",
         "Properties" : {
            "ImageId" : "ami-001e3c51b75397dbe",
            "KeyName" : "capichet-aws-keypair",
            "Tags": [
                {
                    "Key": "Name",
                    "Value": "ConjurMaster"
                }
            ],
            "SecurityGroupIds": [ "sg-c872a7b0" ],
            "SubnetId": "subnet-4190fc37",
            "InstanceType": "t2.small",
            "UserData": {"Fn::Base64": {"Fn::Join":["", [
    "#!/bin/bash\n",
    "echo testlog >> /tmp/mylog.txt\n",
    "echo testlog1 >> /tmp/mylog.txt\n",
    "sleep 5\n",
    "until [ \"`/usr/bin/docker inspect -f {{.State.Running}} conjur-appliance`\"==\"true\" ]; do\n",
    "    sleep 1\n",
    "    echo waiting >> /tmp/mylog.txt\n",
    "done\n",
    "echo testlog3 >> /tmp/mylog.txt\n",
    "sleep 10\n",
    "echo \"Initializing Conjur Master\" >> /tmp/mylog.txt\n",
    "hostname=conjur.cyberark-demo.com\n",
    "password=Cyberark1\n",
    "orgaccount=demo\n",
    "echo \"hostname=$hostname\" >> /tmp/mylog.txt\n",
    "echo \"username=$username\" >> /tmp/mylog.txt\n",
    "echo \"password=$password\" >> /tmp/mylog.txt\n",
    "docker exec conjur-appliance evoke configure master -h $hostname -p $password $orgaccount\n",
    "echo finish runningExec >> /tmp/mylog.txt\n",
            ]]}}
         }

      },
      "ConjurDNSRecord" : {
          "Type" : "AWS::Route53::RecordSet",
          "Properties" : {
             "HostedZoneName" : "cyberark-demo.com.",
             "Comment" : "Auto update from CFN",
             "Name" : "conjur.cyberark-demo.com",
             "TTL" : "60",
             "Type" : "A",
             "ResourceRecords" : [
                { "Fn::GetAtt" : [ "ConjurInstance", "PublicIp" ] }
             ]
          }
      }

   }
}
